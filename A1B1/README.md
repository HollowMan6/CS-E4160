# A1 & B1: Setting up and Networking tools

## 1. VirtualBox virtual machines 
### 1.1 Create yourself a key-pair to be used with the virtual machines. See ssh-keygen(1) for help.

Use `ssh-keygen -t ed25519 -C "songlin.jiang@aalto.fi" -f ~/.ssh/id_ed25519 -q -N ""` to generate a key pair based on ed25519. Let lab2 and lab3 to trust the public key, and use ssh agent forwarding when connecting to lab2 and lab3.

See the scripts in the `scripts` directory for more.

## 2. Networking basics 
### 2.1 Using ip(8), find all the active interfaces on your machine. 

Use: 
```bash
ip link show up
```

Result:
```bash
vagrant@lab1:~$ ip link show up
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
2: enp0s3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP mode DEFAULT group default qlen 1000
    link/ether 02:2d:ad:54:38:ca brd ff:ff:ff:ff:ff:ff
3: enp0s8: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP mode DEFAULT group default qlen 1000
    link/ether 08:00:27:e8:f9:48 brd ff:ff:ff:ff:ff:ff
4: enp0s9: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP mode DEFAULT group default qlen 1000
    link/ether 08:00:27:ce:2b:38 brd ff:ff:ff:ff:ff:ff
```

### 2.2 Using netstat(8) and arp(8), find the MAC address of the default router of your machine.

Use: 
```bash
netstat -r
arp -an
```

Result:
```bash
vagrant@lab1:~$ arp -an | grep $(netstat -r | grep default | tr -s ' ' | cut -d' ' -f2) | cut -d' ' -f4
52:54:00:12:35:02
```

### 2.3 From resolv.conf(5), find the default name servers and the internet domain of your machine. How is this file generated?

This file is automatically generated and managed by systemd-resolved. This is a dynamic resolv.conf file for connecting local clients to the internal DNS stub resolver of systemd-resolved. This file lists all configured search domains

Use: 
```bash
cat /etc/resolv.conf | grep nameserver
```

Result:
```bash
vagrant@lab1:~$ cat /etc/resolv.conf | grep nameserver | cut -d' ' -f2
127.0.0.53
```

This file is automatically generated and managed by systemd-resolved. This is a dynamic resolv.conf file for connecting local clients to the internal DNS stub resolver of systemd-resolved. This file lists all configured search domains.

### 2.4 Using dig(1), find the responsible name servers for the cs.hut.fi domain.

Use: 
```bash
dig cs.hut.fi +short NS 
```

Result:
```bash
vagrant@lab1:~$ dig cs.hut.fi +short NS 
ns.niksula.hut.fi.
sauna.cs.hut.fi.
```

### 2.5 Using dig(1), find the responsible mail exchange servers for cs.hut.fi domain.

Use: 
```bash
dig cs.hut.fi +short MX
```

Result:
```bash
vagrant@lab1:~$ dig cs.hut.fi +short MX
1 mail.cs.hut.fi.
```

### 2.6 Using ping(8), send 5 packets to aalto.fi and find out the average latency. Try then pinging Auckland University of Technology, aut.ac.nz, and see if the latency is different. 

Use: 
```bash
ping aalto.fi -c 5
ping aut.ac.nz -c 5
```

Result:
```bash
vagrant@lab1:~$ ping aalto.fi -c 5
PING aalto.fi (104.17.221.22) 56(84) bytes of data.
64 bytes from 104.17.221.22 (104.17.221.22): icmp_seq=1 ttl=63 time=9.53 ms
64 bytes from 104.17.221.22 (104.17.221.22): icmp_seq=2 ttl=63 time=10.9 ms
64 bytes from 104.17.221.22 (104.17.221.22): icmp_seq=3 ttl=63 time=11.2 ms
64 bytes from 104.17.221.22 (104.17.221.22): icmp_seq=4 ttl=63 time=9.51 ms
64 bytes from 104.17.221.22 (104.17.221.22): icmp_seq=5 ttl=63 time=11.4 ms

--- aalto.fi ping statistics ---
5 packets transmitted, 5 received, 0% packet loss, time 4081ms
rtt min/avg/max/mdev = 9.506/10.510/11.390/0.826 ms
vagrant@lab1:~$ ping aut.ac.nz -c 5
PING aut.ac.nz (156.62.238.90) 56(84) bytes of data.
64 bytes from bax.aut.ac.nz (156.62.238.90): icmp_seq=1 ttl=63 time=312 ms
64 bytes from bax.aut.ac.nz (156.62.238.90): icmp_seq=2 ttl=63 time=312 ms
64 bytes from bax.aut.ac.nz (156.62.238.90): icmp_seq=3 ttl=63 time=311 ms
64 bytes from bax.aut.ac.nz (156.62.238.90): icmp_seq=4 ttl=63 time=314 ms
64 bytes from bax.aut.ac.nz (156.62.238.90): icmp_seq=5 ttl=63 time=334 ms

--- aut.ac.nz ping statistics ---
5 packets transmitted, 5 received, 0% packet loss, time 4101ms
rtt min/avg/max/mdev = 311.366/316.661/333.595/8.539 ms
```

The average latency for aalto.fi is 10.510 ms and for aut.ac.nz is 316.661 ms.

### 2.7 Using traceroute(1), find out how many hops away is amazon.com. Why does this address sometimes produce different results on different traceroute runs? 

Use: 
```bash
traceroute -I amazon.com -m 40
```

Result:
```bash
vagrant@lab1:~$ traceroute -I amazon.com -m 40
traceroute to amazon.com (54.239.28.85), 100 hops max, 60 byte packets
 1  _gateway (10.0.2.2)  0.238 ms  0.223 ms  0.220 ms
 2  _gateway (10.100.0.1)  2.749 ms  2.747 ms  2.744 ms
 3  jgw-2-v100.aalto.fi (130.233.231.19)  43.357 ms  43.354 ms  43.351 ms
 4  funet-100g-aalto-a.aalto.fi (130.233.231.189)  43.348 ms  43.346 ms  43.342 ms
 5  espoo1.ip.funet.fi (86.50.255.232)  44.813 ms  44.809 ms  44.805 ms
 6  fi-csc.nordu.net (109.105.102.168)  64.604 ms  3.058 ms  3.035 ms
 7  de-hmb.nordu.net (109.105.97.77)  22.018 ms  18.980 ms  18.967 ms
 8  nl-ams.nordu.net (109.105.97.80)  25.752 ms  25.749 ms  25.746 ms
 9  us-man.nordu.net (109.105.97.64)  147.815 ms  147.812 ms  147.809 ms
10  nyiix-peering.amazon.com (198.32.160.64)  113.280 ms  113.277 ms  113.274 ms
11  150.222.68.88 (150.222.68.88)  113.271 ms  113.269 ms  113.224 ms
12  150.222.68.91 (150.222.68.91)  116.982 ms  116.973 ms  125.199 ms
13  * * *
14  150.222.68.74 (150.222.68.74)  113.172 ms  116.177 ms  116.150 ms
15  * * *
16  * * *
17  * * *
18  * * *
19  * * *
20  * * *
21  52.93.28.74 (52.93.28.74)  188.709 ms  188.703 ms  188.696 ms
22  * * *
23  * * *
24  * * *
25  * * *
26  * * *
27  * * *
28  * * *
29  * * *
30  * * *
31  * * *
32  * * *
33  * * *
34  * * *
35  54.239.28.85 (54.239.28.85)  234.653 ms  234.648 ms  234.628 ms
```

Because of congestion differences for each run and the Internet tries to choose the best routing option for us.

### 2.8 Using mtr(8) find out the minimum, maximum and average network latency between your machine and google.com Can the packet loss %age > 0 even if there is no loss in transport layer traffic? Why?

Use: 
```bash
mtr -r -c 10 google.com
```

Result:
```bash
vagrant@lab1:~$ mtr -r -c 10 google.com
Start: 2023-01-11T19:18:00+0000
HOST: lab1                        Loss%   Snt   Last   Avg  Best  Wrst StDev
  1.|-- 10.0.2.2                   0.0%    10    0.5   0.5   0.3   0.7   0.1
  2.|-- router.ctc                 0.0%    10    3.8   3.9   3.6   4.5   0.3
  3.|-- gw-1-v325.kyla.fi          0.0%    10    2.5   2.9   2.2   4.3   0.8
  4.|-- funet-espoo1-100g-r1.ayy.  0.0%    10    2.4   3.2   2.4   4.6   0.6
  5.|-- fi-csc.nordu.net           0.0%    10    2.5   2.9   2.5   3.4   0.3
  6.|-- de-hmb.nordu.net           0.0%    10   19.4  19.4  18.2  24.8   2.0
  7.|-- as15169.hamburg.megaport.  0.0%    10   18.7  18.7  18.2  20.9   0.8
  8.|-- 108.170.253.50             0.0%    10   23.8  25.0  23.6  33.2   2.9
  9.|-- 216.239.57.7               0.0%    10   23.7  24.6  23.6  31.5   2.5
 10.|-- 172.253.70.70              0.0%    10   23.4  29.6  23.4  57.3  12.2
 11.|-- 142.250.235.255            0.0%    10   30.8  33.5  30.3  48.3   6.4
 12.|-- 142.250.36.193             0.0%    10   30.2  30.8  29.7  37.0   2.2
 13.|-- 142.250.227.85             0.0%    10   33.4  31.5  30.9  33.4   0.7
 14.|-- bud02s21-in-f14.1e100.net  0.0%    10   30.0  30.2  29.8  30.6   0.2
```

Yes, of couse. As the MTR report can show loss when the destination host is not responding to ICMP packets because the router iptables configure the router to drop those ICMP packages.

## 3. Using nmap(1) to scan networks.
### 3.1 Using nmap(1) to scan your local network, and show the list of all live and up hosts and open ports on VMs.

Use: 
```bash
sudo nmap -sT -p- 192.168.1.0/24 192.168.2.0/24
```

Result:
```bash
vagrant@lab1:~$ sudo nmap -sT -p- 192.168.1.0/24 192.168.2.0/24
Starting Nmap 7.80 ( https://nmap.org ) at 2023-01-12 13:08 UTC
Nmap scan report for lab2 (192.168.1.3)
Host is up (0.00011s latency).
Not shown: 65534 closed ports
PORT   STATE SERVICE
22/tcp open  ssh
MAC Address: 08:00:27:45:72:D1 (Oracle VirtualBox virtual NIC)

Nmap scan report for lab1 (192.168.1.2)
Host is up (0.000032s latency).
Not shown: 65534 closed ports
PORT   STATE SERVICE
22/tcp open  ssh

Nmap scan report for lab3 (192.168.2.3)
Host is up (0.000093s latency).
Not shown: 65534 closed ports
PORT   STATE SERVICE
22/tcp open  ssh
MAC Address: 08:00:27:3D:8F:AB (Oracle VirtualBox virtual NIC)

Nmap scan report for lab1 (192.168.2.2)
Host is up (0.000028s latency).
Not shown: 65534 closed ports
PORT   STATE SERVICE
22/tcp open  ssh

Nmap done: 512 IP addresses (4 hosts up) scanned in 7.70 seconds
```

## 4. Examining the request and response messages of clients and servers using netcat
### 4.1 Using netcat, nc(1), capture the version number of the ssh daemon running on your machine.

Use: 
```bash
nc 127.0.0.1 22
```

Result:
```bash
vagrant@lab1:~$ nc 127.0.0.1 22
SSH-2.0-OpenSSH_8.9p1 Ubuntu-3
```

### 4.2 Using netcat, nc(1), craft a valid HTTP/1.1 request for getting HTTP headers (not the html file itself) from the front page of www.aalto.fi. What request method did you use? Which headers did you need to send to the server? What was the status code for the request? Which headers did the server return? Explain the purpose of each header. 

Use: 
```bash
nc www.aalto.fi 80 <<EOL
GET / HTTP/1.1
Host: www.aalto.fi
Connection: close

EOL
```

Result:
```bash
vagrant@lab1:~$ nc www.aalto.fi 80 <<EOL
GET / HTTP/1.1
Host: www.aalto.fi
Connection: close

EOL
HTTP/1.1 301 Moved Permanently
Date: Wed, 11 Jan 2023 19:44:38 GMT
Transfer-Encoding: chunked
Connection: close
Cache-Control: max-age=3600
Expires: Wed, 11 Jan 2023 20:44:38 GMT
Location: https://www.aalto.fi/fi
Server: cloudflare
CF-RAY: 788025f069a7fe48-HEL

0

```

I use get, specifying the HOST and Connection: close. As unlike HTTP/1.0, HTTP/1.1 doesn't close the connection automatically, but it waits your next URL you want to retrieve, so the Connection header is needed to manually close the connection.

The server return the status code 301, which means the resource has been moved permanently. The server also return the Date of the response. The Transfer-Encoding header specifies the form of encoding used to safely transfer the payload body to the user. The Cache-Control gives instructions — in both requests and responses — for caching in browsers and shared caches (e.g. Proxies, CDNs). The Expires header contains the date/time after which the response is considered expired. The Location response header indicates the URL to redirect a page to. The Server header describes the software used by the origin server that handled the request — that is, the server that generated the response. The CF-RAY header is specific to cloudflare and is used to identify the specific edge server that handled the request.


### 4.3 Using netcat, nc(1), start a bogus web server listening on the loopback interface port 8080. Verify with netstat(8), that the server really is listening where it should be. Direct your browser lynx(1) to the bogus server and capture the User-Agent: header. 

Use: 
```bash
nc -l 8080
lynx 127.0.0.1:8080
```

Result:
```bash
vagrant@lab1:~$ nc -l 8080
GET / HTTP/1.0
Host: 127.0.0.1:8080
Accept: text/html, text/plain, text/sgml, text/css, */*;q=0.01
Accept-Encoding: gzip, compress, bzip2
Accept-Language: en
User-Agent: Lynx/2.9.0dev.10 libwww-FM/2.14 SSL-MM/1.4.1 GNUTLS/3.7.1
```

### 4.4 With similar setup to 3.3, start up a bogus ssh server with nc and try to connect to it with ssh(1). Copy-paste the server version string you captured in 3.1 and see if you get a response from the client. What is the client trying to negotiate?

Use: 
```bash
nc -l 8080
ssh -p 8080 127.0.0.1
```

Result:
```bash
vagrant@lab1:~$ nc -l 8080
SSH-2.0-OpenSSH_8.9p1 Ubuntu-3
SSH-2.0-OpenSSH_8.9p1 Ubuntu-3
�΄�Dg|
      ���`ň=gcurve25519-sha256,curve25519-sha256@libssh.org,ecdh-sha2-nistp256,ecdh-sha2-nistp384,ecdh-sha2-nistp521,sntrup761x25519-sha512@openssh.com,diffie-hellman-group-exchange-sha256,diffie-hellman-group16-sha512,diffie-hellman-group18-sha512,diffie-hellman-group14-sha256,ext-info-c�ssh-ed25519-cert-v01@openssh.com,ecdsa-sha2-nistp256-cert-v01@openssh.com,ecdsa-sha2-nistp384-cert-v01@openssh.com,ecdsa-sha2-nistp521-cert-v01@openssh.com,sk-ssh-ed25519-cert-v01@openssh.com,sk-ecdsa-sha2-nistp256-cert-v01@openssh.com,rsa-sha2-512-cert-v01@openssh.com,rsa-sha2-256-cert-v01@openssh.com,ssh-ed25519,ecdsa-sha2-nistp256,ecdsa-sha2-nistp384,ecdsa-sha2-nistp521,sk-ssh-ed25519@openssh.com,sk-ecdsa-sha2-nistp256@openssh.com,rsa-sha2-512,rsa-sha2-256lchacha20-poly1305@openssh.com,aes128-ctr,aes192-ctr,aes256-ctr,aes128-gcm@openssh.com,aes256-gcm@openssh.comlchacha20-poly1305@openssh.com,aes128-ctr,aes192-ctr,aes256-ctr,aes128-gcm@openssh.com,aes256-gcm@openssh.com�umac-64-etm@openssh.com,umac-128-etm@openssh.com,hmac-sha2-256-etm@openssh.com,hmac-sha2-512-etm@openssh.com,hmac-sha1-etm@openssh.com,umac-64@openssh.com,umac-128@openssh.com,hmac-sha2-256,hmac-sha2-512,hmac-sha1�umac-64-etm@openssh.com,umac-128-etm@openssh.com,hmac-sha2-256-etm@openssh.com,hmac-sha2-512-etm@openssh.com,hmac-sha1-etm@openssh.com,umac-64@openssh.com,umac-128@openssh.com,hmac-sha2-256,hmac-sha2-512,hmac-sha1�none,zlib@openssh.com,zlib�none,zlib@openssh.com,zlib
```

Ihe client is trying to negotiate the encryption algorithm.

## 5. Vagrant 
### 5.1 Which providers does vagrant support?What does command: \<vagrant init\> do?

https://developer.hashicorp.com/vagrant/docs/providers

Vagrant ships out of the box with support for VirtualBox, Hyper-V, and Docker, Vagrant has the ability to manage other types of machines as well. This is done by using other providers with Vagrant.

Alternate providers can offer different features that make more sense in your use case. For example, if you are using Vagrant for any real work, VMware providers are recommended since they're well supported and generally more stable and performant than VirtualBox.

https://developer.hashicorp.com/vagrant/docs/cli/init

This initializes the current directory to be a Vagrant environment by creating an initial Vagrantfile if one does not already exist.

### 5.2 What is box in Vagrant? How to add a box to the vagrant environment?

https://developer.hashicorp.com/vagrant/docs/boxes

Boxes are the package format for Vagrant environments. You specify a box environment and operating configurations in your Vagrantfile. You can use a box on any supported platform to bring up identical working environments.

You can add a box from the public catalog at any time. The box's description includes instructions on how to add it to an existing Vagrantfile or initiate it as a new environment on the command-line.

https://developer.hashicorp.com/vagrant/docs/boxes/base

### 5.3 Show the provisioning part of your sample code and explain it?

See comments in Vagrantfile.

### 5.4 Upload a file from your host to a vm? Share a folder on your host to a vm.

Use: 
```bash
# vagrant plugin install vagrant-scp
vagrant scp Vagrantfile lab1:/home/vagrant/
```

https://developer.hashicorp.com/vagrant/docs/synced-folders
https://developer.hashicorp.com/vagrant/docs/synced-folders/basic_usage

### 5.5 Show the running boxes in your provider via ssh?

Use: 
```bash
vagrant box list
VBoxManage list runningvms
```

Result:
```bash
hollowman@hollow-Laptop:~/Downloads/CS-E4160/A1B1$ vagrant box list
ubuntu/jammy64 (virtualbox, 20230110.0.0)
hollowman@hollow-Laptop:~/Downloads/CS-E4160/A1B1$ VBoxManage list runningvms
"A1B1_lab1_1673461225578_76173" {e26c1460-0b8d-4614-acb4-07b1bd005441}
"A1B1_lab2_1673461264807_31948" {5f88799e-7403-46f9-8104-c0e0c531dbc7}
"A1B1_lab3_1673461304853_41136" {b8c7b8fb-6e0d-4700-9967-dfdd5507045c}
```